services:
  postgres:
    image: postgres:17.5
    container_name: fj-postgres
    hostname: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fj_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fj_pass}
      POSTGRES_DB: ${POSTGRES_DB:-fj}
      TZ: Europe/Moscow
    ports:
      - "${POSTGRES_PORT:-5436}:5432"
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
    networks:
      - network

  elasticsearch:
    build:
      context: ./elasticsearch
      dockerfile: Dockerfile
    container_name: fj-elasticsearch
    hostname: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./volumes/es:/data
    restart: unless-stopped
    networks:
      - network

  kibana:
    image: kibana:9.2.0
    container_name: fj-kibana
    hostname: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
    depends_on:
      - elasticsearch
    restart: unless-stopped
    networks:
      - network

  minio:
    image: quay.io/minio/minio:RELEASE.2024-03-15T01-07-19Z
    container_name: fj-minio
    hostname: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-password}
    volumes:
      - ./volumes/s3:/data
    ports:
      - "${S3_API_PORT:-9910}:9000"
      - "${S3_CONSOLE_PORT:-9911}:9001"
    restart: unless-stopped
    networks:
      - network

  rabbitmq:
    image: rabbitmq:4.1.2-management
    container_name: fj-rabbit
    hostname: rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5676}:5672"  # AMQP
      - "${RABBITMQ_MANAGEMENT_PORT:-15676}:15672"  # Web UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_ADMIN_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_ADMIN_PASSWORD:-password}
      TZ: Europe/Moscow
    volumes:
      - ./volumes/rabbitmq:/var/lib/rabbitmq
    networks:
      - network

  redis:
    image: redis:8.2.2-alpine3.22
    container_name: fj-redis
    hostname: redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-password}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-password}
    ports:
      - "6380:6379"
    volumes:
      - ./volumes/redis:/data
    networks:
      - network

  notification-bot:
    build:
      context: ./notifications
      dockerfile: Dockerfile
    container_name: fj-notification-bot
    hostname: notifications
    depends_on:
      - postgres
      - rabbitmq
    environment:
      RMQ_CONN: ${RMQ_CONN:-amqp://admin:password@rabbitmq:5672}
    env_file:
      - ./notifications/bot.env
    restart: unless-stopped
    networks:
      - network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fj-backend
    hostname: backend
    depends_on:
      - postgres
      - rabbitmq
      - minio
      - elasticsearch
      - kibana
    ports:
      - "${BACKEND_PORT:-8100}:8000"
    environment:
      APP_MODE: local
      DB_CONN: ${DB_CONN:-fj_user:fj_pass@postgres:5432/fj}
      RMQ_CONN: ${RMQ_CONN:-amqp://admin:password@rabbitmq:5672}
      CORS: ${CORS:-http://localhost:9999}
      ALLOW_AUTHENTICATION: ${ALLOW_AUTHENTICATION:-true}
      ALLOW_REGISTRATION: ${ALLOW_REGISTRATION:-true}
      ADMIN_USER: ${ADMIN_USER:-admin}
      ADMIN_PASS: ${ADMIN_PASS:-password}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-admin}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-password}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      ELASTICSEARCH_URL: ${ELASTICSEARCH_URL:-http://elasticsearch:9200}
    restart: unless-stopped
    networks:
      - network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        API_BASE_URL: ${API_BASE_URL:-/api}
    container_name: fj-frontend
    hostname: frontend
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    restart: unless-stopped
    networks:
      - network

  nginx:
    image: nginx:alpine
    container_name: fj-nginx
    ports:
      - "9999:80"
    volumes:
      - ./volumes/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - frontend
      - minio
    restart: unless-stopped
    networks:
      - network

networks:
  network:
    driver: bridge
