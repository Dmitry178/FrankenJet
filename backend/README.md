# FrankenJet Backend

## Описание

Backend для **FrankenJet** — энциклопедии истории авиации. Представляет собой асинхронное API, разработанное с использованием **FastAPI**, для предоставления и управления данными проекта, такими как статьи, воздушные суда, конструкторские бюро, конструкторы и производители. Архитектура бэкенда построена с учётом масштабируемости, безопасности и эффективности.

## Технологии

* **Язык программирования:** Python 3.12
* **Фреймворк API:** [FastAPI](https://fastapi.tiangolo.com/) (асинхронный)
* **База данных:** [PostgreSQL 17](https://www.postgresql.org/)
* **ORM:** [SQLAlchemy 2](https://www.sqlalchemy.org/) (асинхронный режим)
* **Драйвер базы данных:** [asyncpg](https://magicstack.github.io/asyncpg/)
* **Миграции:** [Alembic](https://alembic.sqlalchemy.org/)
* **Аутентификация/Авторизация:** JWT (Access/Refresh токены)
* **Обработка изображений/файлов:** [AIOBoto3](https://aioboto3.readthedocs.io/) (для S3-совместимого хранилища, например, MiniO)
* **HTTP-клиент:** [AIOHTTP](https://docs.aiohttp.org/)
* **Брокер сообщений:** [RabbitMQ](https://www.rabbitmq.com/) (через [FastStream](https://faststream.airt.ai/))
* **Кэширование:** [FastAPI-Cache2](https://github.com/indominusbyte/fastapi-cache) (Redis)
* **Контейнеризация:** [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/)
* **Конфигурация:** [Pydantic Settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
* **Линтеры:** [Ruff](https://github.com/astral-sh/ruff), [MyPy](https://mypy.readthedocs.io/)

## Архитектура

Проект бэкенда (**backend/**) организован по слоям и паттернам, способствующим поддержке и расширяемости:

* **`app/api/`**: Определение маршрутов (эндпоинтов) FastAPI.
* **`app/config/`**: Конфигурация приложения (настройки из **.env**).
* **`app/consumers/`**: Обработчики сообщений из RabbitMQ (Consumer).
* **`app/core/`**: Основные модули, утилиты, контекстные менеджеры.
* **`app/db/`**:
    * **`models/`**: SQLAlchemy-модели (ORM).
    * **`repositories/`**: Паттерн Repository для абстрагирования логики доступа к данным.
* **`app/dependencies/`**: Компоненты для внедрения зависимостей (Dependency Injection) в FastAPI.
* **`app/exceptions/`**: Пользовательские исключения.
* **`app/schemas/`**: Pydantic-схемы для валидации входящих и исходящих данных.
* **`app/services/`**: Сервисный слой (бизнес-логика), взаимодействует с репозиториями.
* **`scripts/`**: Скрипты для инициализации БД, загрузки начальных данных и настройки S3 при запуске через Docker Compose.

### Ключевые архитектурные компоненты

* **Паттерн Repository**: Инкапсулирует логику доступа к базе данных, делая код сервисов независимым от конкретной реализации ORM.
* **Сервисный слой (Service Layer)**: Централизует бизнес-логику приложения. API-эндпоинты вызывают методы сервисов, которые, в свою очередь, взаимодействуют с репозиториями.
* **Контекстные менеджеры**:
    * **DBManager**: Управление сессиями базы данных (асинхронные сессии SQLAlchemy), включая транзакции.
    * **S3Manager**: Управление подключением и операциями (загрузка, удаление) с S3-совместимым хранилищем.
    * **RMQManager**: Управление подключением и публикацией/подпиской к сообщениям в RabbitMQ, включая логику повторных подключений. Менеджер изолирует код от прямой зависимости от **RabbitMQ**.
* **Менеджеры**:
    * **WSManager**: Управление подключениями WebSocket.
    * **CacheManager**: Управление кэшированием через **fastapi-cache2**, изолирует код от прямой зависимости от Redis.
* **WebSocket**: Используется для аутентифицированных пользователей, например, для функционала "выйти на всех устройствах".

## Функциональность

* **Аутентификация и авторизация**:
    * Регистрация и вход по email/паролю.
    * Вход через Google OAuth.
    * Использование пары JWT-токенов (access/refresh).
    * Ролевая авторизация (admin, editor, moderator).
* **Управление данными**:
    * CRUD-операции для сущностей (пользователи, статьи, воздушные суда, бюро, конструкторы, производители).
    * API для получения данных по каждой категории.
    * Кэширование статей и настроек приложения.
* **Интеграции**:
    * Хранение и обслуживание изображений через S3-совместимое хранилище (MiniO).
    * Отправка уведомлений и событий в брокер сообщений (RabbitMQ) для обработки микросервисами (например, Telegram-ботом).
* **Миграции**: Настроены скрипты Alembic для управления изменениями схемы БД в разных средах.
* **Инициализация**: Скрипты для создания БД, загрузки начальных данных (ролей пользователей, статей и т.д.) и начальных изображений в S3.

## Roadmap

* **Тестирование**: Написание unit- и интеграционных тестов.
* **Мониторинг**: Интеграция с Prometheus, Grafana, Grafana Loki.
* **Новые сущности**: Модели и API для персоналий и исторических событий.
* **Безопасность**: Добавление аутентификации через VK, Yandex, Telegram.
* **Дополнительно**: Разработка админ-панели.
